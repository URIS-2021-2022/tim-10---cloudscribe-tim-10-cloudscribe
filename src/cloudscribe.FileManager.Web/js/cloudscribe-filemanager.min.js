(function(){var n={treeDataApiUrl:$("#fmconfig").data("filetree-url"),fileType:$("#fmconfig").data("filet-type"),uploadApiUrl:$("#fmconfig").data("upload-url"),createFolderApiUrl:$("#fmconfig").data("create-folder-url"),deleteFolderApiUrl:$("#fmconfig").data("delete-folder-url"),renameFolderApiUrl:$("#fmconfig").data("rename-folder-url"),deleteFileApiUrl:$("#fmconfig").data("delete-file-url"),renameFileApiUrl:$("#fmconfig").data("rename-file-url"),canDelete:$("#fmconfig").data("can-delete"),emptyPreviewUrl:$("#fmconfig").data("empty-preview-url"),rootVirtualPath:$("#fmconfig").data("root-virtual-path"),rootButton:$("#btnRoot"),fileSelectorButton:$("#btnSelector"),deleteFolderButton:$("#btnDeleteFolder"),renameFolderButton:$("#btnRenameFolder"),selectForCropButton:$("#btnSelectForCrop"),deleteFileButton:$("#btnDeleteFile"),renameFileButton:$("#btnRenameFile"),selectedFileInput:$("#fileSelection"),newFolderButton:$("#btnCreateFolder"),progressUI:$("#progress"),uploadTab:$("#tab2"),cropTab:$("#tab3"),treeData:[],selectedFileList:[],setCropImageFromServer:function(){var t=n.selectedFileInput.val(),i;$("#image").attr("src",t);$("#cropCurrentDirLabel").html(t.substring(0,t.lastIndexOf("/")));$("#cropCurrentDir").val(t.substring(0,t.lastIndexOf("/")));i=t.substring(t.lastIndexOf("/"));$("#croppedFileName").val(i);$("#origFileName").val(i);$("#lnkCrop").trigger("click")},clearServerCropImage:function(){$("#image").attr("src",n.emptyPreviewUrl);$("#croppedFileName").val("");$("#origFileName").val("")},setPreview:function(t){$("#filePreview").attr("src",t);n.uploadTab.hide();n.selectForCropButton.show()},clearPreview:function(){$("#filePreview").attr("src",n.emptyPreviewUrl);$("#fileCropPreview").attr("src",n.emptyPreviewUrl);$("#croppedFileName").val("");n.uploadTab.show();n.selectForCropButton.hide();n.clearServerCropImage()},setCurrentDirectory:function(t){$("#newFolderCurrentDir").val(t);$("#hdnCurrentVirtualPath").val(t);$("#uploadCurrentDir").val(t);$("#cropCurrentDir").val(t);$("#cropCurrentDirLabel").html(t+"/");$("#currentFolder").html(t);$("#folderToDelete").val(t);$("#folderToRename").val(t);n.showFolderTools()},clearCurrentDirectory:function(){$("#newFolderCurrentDir").val(n.rootVirtualPath);$("#hdnCurrentVirtualPath").val(n.rootVirtualPath);$("#uploadCurrentDir").val(n.rootVirtualPath);$("#currentFolder").html(n.rootVirtualPath);$("#folderToDelete").val("");$("#folderToRename").val("");n.hideFolderTools()},setCurrentFile:function(t,i){n.selectedFileInput.val(t);$("#newFolderCurrentDir").val(t.substring(0,t.lastIndexOf("/")));$("#fileToRename").val(t);$("#fileToDelete").val(t);i&&$("#newFileNameSegment").val(i);n.showFileTools()},clearCurrentFile:function(){n.selectedFileInput.val("");$("#fileToRename").val("");$("#fileToDelete").val("");$("#newFileNameSegment").val("");n.hideFileTools();n.clearPreview()},backToRoot:function(){n.clearCurrentFile();n.clearCurrentDirectory();n.clearPreview();n.setCurrentDirectory(n.rootVirtualPath);n.loadTree()},showFolderTools:function(){if(n.canDelete){var t=$("#hdnCurrentVirtualPath").val();t!=n.rootVirtualPath&&($("#frmDeleteFolder").show(),$("#frmRenameFolder").show())}$("#frmNewFolder").show()},hideFolderTools:function(){$("#frmDeleteFolder").hide();$("#frmRenameFolder").hide();$("#frmNewFolder").hide()},showFileTools:function(){n.canDelete&&($("#frmDeleteFile").show(),$("#frmRenameFile").show())},hideFileTools:function(){$("#frmDeleteFile").hide();$("#frmRenameFile").hide()},notify:function(n,t){$("#alert_placeholder").html('<div class="alert '+t+'"><a class="close" data-dismiss="alert">Ã—<\/a><span>'+n+"<\/span><\/div>")},addFileToList:function(n,t,i,r){var u=$("<span class='fa fa-trash-o' aria-role='button' title='Remove'><\/span>").click(function(){n.files.splice(i,1);t=n.files;$("#fileList li").eq(i).remove();t.length===0&&$("#fileList").html("")}),f=$("<li>",{text:r.name}).append("&nbsp;").append(u);$("#fileList ul").append(f)},addErrorToList:function(n,t){var i=$("<li>",{text:t.ErrorMessage});$("#fileList ul").append(i)},createFolder:function(){var t=$("#frmNewFolder").serializeArray();return $.ajax({method:"POST",url:n.createFolderApiUrl,data:t}).done(function(t){if(t.succeeded){var i=$("#newFolderCurrentDir").val();i===n.rootVirtualPath?n.loadTree():n.reloadSubTree();$("#newFolderName").val("")}else n.notify(t.message,"alert-danger")}).fail(function(){n.notify("An error occured","alert-danger")}),!1},deleteFolder:function(){var t=$("#folderToDelete").val(),i;return t===n.rootVirtualPath?!1:(confirm("Are you sure you want to permanently delete the folder "+t+" and any files or folders below it?")&&(i=$("#frmDeleteFolder").serializeArray(),$.ajax({method:"POST",url:n.deleteFolderApiUrl,data:i}).done(function(i){i.succeeded?(n.removeNode(t),n.clearCurrentDirectory()):n.notify(i.message,"alert-danger")}).fail(function(){n.notify("An error occured","alert-danger")})),!1)},renameFolder:function(){var t=$("#folderToRename").val(),i;return t===n.rootVirtualPath?!1:(confirm("Are you sure you want to rename the folder "+t+"?")&&(i=$("#frmRenameFolder").serializeArray(),$.ajax({method:"POST",url:n.renameFolderApiUrl,data:i}).done(function(i){var u,f,r;i.succeeded?(u=$("#tree").treeview(!0),f=u.findNodes(t,"id"),f&&(r=u.getParents(f),r&&r.length>0?n.reloadSubTree(r[0].id):n.loadTree()),$("#newNameSegment").val(""),n.clearCurrentDirectory()):n.notify(i.message,"alert-danger")}).fail(function(){n.notify("An error occured","alert-danger")})),!1)},deleteFile:function(){var t=$("#fileToDelete").val(),i;return t===""?!1:t===n.rootVirtualPath?!1:(confirm("Are you sure you want to permanently delete the file "+t+"?")&&(i=$("#frmDeleteFile").serializeArray(),$.ajax({method:"POST",url:n.deleteFileApiUrl,data:i}).done(function(i){i.succeeded?(n.removeNode(t),n.clearCurrentFile()):n.notify(i.message,"alert-danger")}).fail(function(){n.notify("An error occured","alert-danger")})),!1)},renameFile:function(){var t=$("#fileToRename").val(),i;return t===""?!1:t===n.rootVirtualPath?!1:(confirm("Are you sure you want to rename the file "+t+"?")&&(i=$("#frmRenameFile").serializeArray(),$.ajax({method:"POST",url:n.renameFileApiUrl,data:i}).done(function(i){var u,f,r;i.succeeded?(u=$("#tree").treeview(!0),f=u.findNodes(t,"id"),f&&(r=u.getParents(f),r&&r.length>0&&n.reloadSubTree(r[0].id)),n.clearCurrentFile()):n.notify(i.message,"alert-danger")}).fail(function(){n.notify("An error occured","alert-danger")})),!1)},ckReturnFile:function(){var i=$("#fmconfig").data("ckfunc"),t=n.selectedFileInput.val();t.length===0?n.notify("Please select a file in the browse tab","alert-danger"):(window.opener.CKEDITOR.tools.callFunction(i,t),window.close())},removeNode:function(n){var t=$("#tree").treeview(!0),i=t.findNodes(n,"id");t.removeNode(i,{silent:!0})},reloadSubTree:function(t){var u=$("#tree").treeview(!0),f=t||$("#uploadCurrentDir").val(),r,i,e;if(f.length===0||f===n.rootVirtualPath){n.loadTree();return}if(r=u.findNodes(f,"id"),r.length>0){u.collapseNode(r,{silent:!0,ignoreChildren:!1});i=r[0];e={text:i.text,id:i.id,type:i.type,icon:i.icon,expandedIcon:i.expandedIcon,virtualPath:i.virtualPath,nodes:[],lazyLoad:!0};u.updateNode(i,e,{silent:!0});r=u.findNodes(f,"id");try{u.expandNode(r,{silent:!0,ignoreChildren:!1})}catch(o){}}else alert("node not found")},loadTree:function(){$("#tree").treeview({dataUrl:{method:"GET",dataType:"json",url:n.treeDataApiUrl,cache:!1},nodeIcon:"fa fa-folder",collapseIcon:"fa fa-minus",emptyIcon:"fa",expandIcon:"fa fa-plus",loadingIcon:"fa fa-hourglass-o",levels:2,onhoverColor:"#F5F5F5",highlightSelected:!0,showBorder:!0,showCheckbox:!1,showIcon:!0,wrapNodeText:!1,lazyLoad:function(t,i){$.ajax({dataType:"json",url:n.treeDataApiUrl+"&virtualStartPath="+t.virtualPath}).done(function(n){i(n)});t.lazyLoaded=!0},onNodeSelected:function(t,i){i.canPreview?n.setPreview(i.virtualPath,i.text):n.clearPreview();i.type==="d"?(n.setCurrentDirectory(i.virtualPath),n.clearCurrentFile(),n.hideFileTools()):(n.hideFolderTools(),n.setCurrentFile(i.virtualPath,i.text))},onNodeUnselected:function(t,i){i.lazyLoaded&&(i.lazyLoaded=!1);i.type==="d"?n.hideFolderTools():n.hideFileTools()}})},setupFileLoader:function(){$("#pnlFiles").fileupload({fileInput:$("#fileupload"),url:n.uploadApiUrl,dataType:"json",autoUpload:!1,singleFileUploads:!1,limitMultiFileUploads:10,limitConcurrentUploads:10,dropZone:$("#dropZone"),pasteZone:$("#dropZone"),add:function(t,i){var f,e;$("#fileList").html("");$("#fileList").append($("<ul class='filelist'><\/ul>"));for(var o=allowedFilesRegex,r=0,u=i.files.length;r<u;)o.test(i.files[r].name)===!1&&(i.files.splice(r,1),u=i.files.length,r=-1),r++;for(n.selectedFileList=n.selectedFileList.concat(i.files),f=10;n.selectedFileList.length>f;)n.selectedFileList.pop();i.files=n.selectedFileList;i.files.length>0&&(e=$("<button id='btnSend' class='btn btn-success'><i class='fa fa-cloud-upload' aria-hidden='true'><\/i> Upload<\/button>"),e.appendTo($("#fileList")));$.each(i.files,function(t,r){n.addFileToList(i,n.selectedFileList,t,r)});$("#btnSend").click(function(){i.context=$("<p/>").text("Uploading...").replaceAll($(this));i.submit()})},done:function(t,i){$("#progress").hide();$("#fileList").html("");fileListuploader=[];$("#fileList").append($("<ul class='filelist file-errors'><\/ul>"));for(var r=0,u=!1;r<i.length;)i[r].errorMessage&&(u=!0,addErrorToList(r,i[r])),r++;n.reloadSubTree()},progressall:function(t,i){var r=parseInt(i.loaded/i.total*100,10);n.progressUI.show();$("#progress .progress-bar").css("width",r+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?undefined:"disabled");$("#fileupload").bind("fileuploadsubmit",function(n,t){return t.formData=$("#frmUpload").serializeArray(),!0})},init:function(){$(document).bind("drop dragover",function(n){n.preventDefault()});this.progressUI.hide();this.loadTree();this.setupFileLoader();this.newFolderButton.on("click",n.createFolder);this.fileSelectorButton.on("click",n.ckReturnFile);this.deleteFolderButton.on("click",n.deleteFolder);this.renameFolderButton.on("click",n.renameFolder);this.deleteFileButton.on("click",n.deleteFile);this.renameFileButton.on("click",n.renameFile);this.selectForCropButton.on("click",n.setCropImageFromServer);this.setCurrentDirectory(this.rootVirtualPath);this.rootButton.on("click",n.backToRoot)}},t;n.init();t={uploadUrl:$("#fmconfig").data("upload-url"),URL:window.URL||window.webkitURL,console:window.console||{log:function(){}},image:$("#image"),saveLocalButton:$("#btnSaveLocal"),uploadCropButton:$("#btnUploadCrop"),croppedFileName:$("#croppedFileName"),chkConstrainCrop:$("#chkContrainWidthOfCrop"),cropMaxWidthInput:$("#cropMaxWidth"),dataX:$("#dataX"),dataY:$("#dataY"),dataHeight:$("#dataHeight"),dataWidth:$("#dataWidth"),dataRotate:$("#dataRotate"),dataScaleX:$("#dataScaleX"),dataScaleY:$("#dataScaleY"),outputHeight:$("#dataNewHeight"),outputWidth:$("#dataNewWidth"),setup:function(){var r={aspectRatio:16/9,preview:".img-preview",crop:function(i){var f,u,r,o,e,s;t.dataX.val(Math.round(i.x));t.dataY.val(Math.round(i.y));f=Math.round(i.height);u=Math.round(i.width);t.dataHeight.val(f);t.dataWidth.val(u);t.dataRotate.val(i.rotate);t.dataScaleX.val(i.scaleX);t.dataScaleY.val(i.scaleY);r=Math.round(t.cropMaxWidthInput.val());t.chkConstrainCrop.is(":checked")&&u>r?(t.outputWidth.val(r),o=t.getCropAspectRatio(),e=parseInt(r/o),t.outputHeight.val(e),t.setCroppedFileName(r,e)):(t.outputHeight.val(f),t.outputWidth.val(u),t.setCroppedFileName(Math.round(i.width),Math.round(i.height)));$.isFunction(document.createElement("canvas").getContext)&&(s=t.image.attr("src"),s===n.emptyPreviewUrl?t.uploadCropButton.prop("disabled",!0):t.uploadCropButton.prop("disabled",!1))}},f=t.image.attr("src"),i,u;$('[data-toggle="tooltip"]').tooltip();t.image.on({ready:function(n){console.log(n.type)},cropstart:function(n){console.log(n.type,n.action)},cropmove:function(n){console.log(n.type,n.action)},cropend:function(n){console.log(n.type,n.action)},crop:function(n){console.log(n.type,n.x,n.y,n.width,n.height,n.rotate,n.scaleX,n.scaleY)},zoom:function(n){console.log(n.type,n.ratio)}}).cropper(r);$.isFunction(document.createElement("canvas").getContext)||t.uploadCropButton.prop("disabled",!0);typeof document.createElement("cropper").style.transition=="undefined"&&($('button[data-method="rotate"]').prop("disabled",!0),$('button[data-method="scale"]').prop("disabled",!0));typeof t.saveLocalButton[0].download=="undefined"&&t.saveLocalButton.addClass("disabled");$(".docs-toggles").on("change","input",function(){var n=$(this),i=n.attr("name"),u=n.prop("type"),f,e;t.image.data("cropper")&&(u==="checkbox"?(r[i]=n.prop("checked"),f=t.image.cropper("getCropBoxData"),e=t.image.cropper("getCanvasData"),r.ready=function(){t.image.cropper("setCropBoxData",f);t.image.cropper("setCanvasData",e)}):u==="radio"&&(r[i]=n.val()),t.image.cropper("destroy").cropper(r))});$("#btnUploadCropped").on("click",t.uploadCroppedImage);t.outputWidth.on("blur",function(){var r=t.getCropAspectRatio(),i=parseInt(t.outputWidth.val()),u=parseInt(t.outputHeight.val()),n=parseInt(i/r),f=Math.abs(n-u);f>1&&(t.outputHeight.val(n),t.setCroppedFileName(i,n))});t.outputHeight.on("blur",function(){var r=t.getCropAspectRatio(),i=parseInt(t.outputHeight.val()),u=parseInt(t.outputWidth.val()),n=parseInt(i*r),f=Math.abs(n-u);f>1&&(t.outputWidth.val(n),t.setCroppedFileName(n,i))});t.chkConstrainCrop.change(function(){var n,i;if($(this).is(":checked")){if(n=Math.round(t.cropMaxWidthInput.val()),i=parseInt(t.dataWidth.val()),i>n){t.outputWidth.val(n);var f=parseInt(t.dataHeight.val()),r=t.getCropAspectRatio(),u=parseInt(n/r);t.outputHeight.val(u)}}else t.outputHeight.val(t.dataHeight.val()),t.outputWidth.val(t.dataWidth.val())});$(".docs-buttons").on("click","[data-method]",function(){var e=$(this),n=e.data(),u,r;if(!e.prop("disabled")&&!e.hasClass("disabled")&&t.image.data("cropper")&&n.method){if(n=$.extend({},n),typeof n.target!="undefined"&&(u=$(n.target),typeof n.option=="undefined"))try{n.option=JSON.parse(u.val())}catch(o){console.log(o.message)}n.method==="rotate"&&t.image.cropper("clear");typeof n.option=="undefined"&&n.method==="getCroppedCanvas"&&(n.option={width:t.outputWidth.val(),height:t.outputHeight.val()});r=t.image.cropper(n.method,n.option,n.secondOption);n.method==="rotate"&&t.image.cropper("crop");switch(n.method){case"scaleX":case"scaleY":$(this).data("option",-n.option);break;case"getCroppedCanvas":r&&($("#getCroppedCanvasModal").modal().find(".modal-body").html(r),t.saveLocalButton.hasClass("disabled")||t.saveLocalButton.attr("href",r.toDataURL("image/jpeg")));break;case"destroy":i&&(URL.revokeObjectURL(i),i="",t.image.attr("src",f))}if($.isPlainObject(r)&&u)try{u.val(JSON.stringify(r))}catch(o){console.log(o.message)}}});$(document.body).on("keydown",function(n){if(t.image.data("cropper")&&!(this.scrollTop>300))switch(n.which){case 37:n.preventDefault();t.image.cropper("move",-1,0);break;case 38:n.preventDefault();t.image.cropper("move",0,-1);break;case 39:n.preventDefault();t.image.cropper("move",1,0);break;case 40:n.preventDefault();t.image.cropper("move",0,1)}});u=$("#inputImage");t.URL?u.change(function(){var f=this.files,n;t.image.data("cropper")&&f&&f.length&&(n=f[0],/^image\/\w+$/.test(n.type)?(i&&URL.revokeObjectURL(i),i=t.URL.createObjectURL(n),$("#origFileName").val(n.name.toLowerCase()),t.croppedFileName.val(n.name.toLowerCase()),t.image.cropper("destroy").attr("src",i).cropper(r),u.val("")):window.alert("Please choose an image file."))}):u.prop("disabled",!0).parent().addClass("disabled")},tearDown:function(){$("#image").data("cropper")&&$("#image").cropper("destroy")},setCroppedFileName:function(n,i){var r=$("#origFileName").val(),u=r.substring(0,r.lastIndexOf(".")),f=r.substring(r.lastIndexOf("."));t.croppedFileName.val(u+"-"+n+"x"+i+f);t.saveLocalButton.attr("download",t.croppedFileName.val())},getCropAspectRatio:function(){var n=$("#image").cropper("getCropBoxData");return n.width/n.height},uploadCroppedImage:function(){var i={width:t.outputWidth.val(),height:t.outputHeight.val()};return $("#image").cropper("getCroppedCanvas",i).toBlob(function(i){var r=new FormData,u;r.append(t.croppedFileName.val(),i);u=$("#frmUploadCropped").serializeArray();$.each(u,function(n,t){r.append(t.name,t.value)});$.ajax({method:"POST",url:n.uploadApiUrl,data:r,processData:!1,contentType:!1}).done(function(t){if(t[0].errorMessage)n.notify(t[0].errorMessage,"alert-danger");else{var i=$("#cropCurrentDir").val();i===n.rootVirtualPath?n.loadTree():n.reloadSubTree(i);$("#getCroppedCanvasModal").modal("hide");n.notify("Cropped image upload succeeded","alert-success")}}).fail(function(t,i,r){n.notify(r,"alert-danger")})}),!1}};$('a[data-toggle="tab"]').on("shown.bs.tab",function(n){var u=$(n.target).attr("href"),i,r;u==="#tabCrop"?t.setup():(i=$(n.relatedTarget).attr("href"),i&&(r=i.replace(/^.*?(#|$)/,""),r==="tabCrop"&&t.tearDown()))})})();